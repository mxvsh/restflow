# Advanced Assertions Flow
# Demonstrates complex assertion patterns and JSONPath usage

@name "Advanced Assertions"

## Setup - Get authentication token
POST {{BASE_URL}}/auth/login
Content-Type: application/json

{
  "username": "{{TEST_USERNAME}}",
  "password": "{{TEST_PASSWORD}}"
}

@assert status == 200
@capture token body.token

## Get sample data for complex assertions
GET {{BASE_URL}}/sample/complex-data
Authorization: Bearer {{token}}

@assert status == 200

# Basic existence checks
@assert body.users exists
@assert body.products exists
@assert body.metadata exists

# Array length assertions
@assert body.users.length > 0
@assert body.products.length >= 5

# JSONPath assertions for nested data
@assert body.users[0].name exists
@assert body.users[0].email contains "@"
@assert body.products[0].price > 0

# Complex JSONPath queries
@assert body.users[*].id exists
@assert body.products[?(@.featured == true)] exists

# String pattern matching
@assert body.metadata.version matches "\\d+\\.\\d+\\.\\d+"
@assert body.metadata.environment matches "(dev|test|prod)"

# Numeric comparisons
@assert body.metadata.uptime > 0
@assert body.metadata.requestCount >= 0

# Date/time validation
@assert body.metadata.lastUpdated exists
@assert body.metadata.startTime exists

# Conditional assertions based on environment
GET {{BASE_URL}}/config/features
Authorization: Bearer {{token}}

@assert status == 200
@assert body.debugMode == {{DEBUG}}
@assert body.rateLimit == {{RATE_LIMIT}}

# Capture complex values for later use
@capture firstUserId body.users[0].id
@capture featuredProducts body.products[?(@.featured == true)]
@capture serverVersion body.metadata.version

## Verify captured values work in subsequent requests
GET {{BASE_URL}}/users/{{firstUserId}}
Authorization: Bearer {{token}}

@assert status == 200
@assert body.id == {{firstUserId}}

## Test response time assertions
GET {{BASE_URL}}/performance/test
Authorization: Bearer {{token}}

@assert status == 200
@assert responseTime < 2000
@assert responseTime > 10

## Test header assertions
GET {{BASE_URL}}/headers/test
Authorization: Bearer {{token}}
X-Custom-Header: test-value

@assert status == 200
@assert headers.x-response-time exists
@assert headers.content-type == "application/json"
@assert headers.x-api-version matches "v\\d+"